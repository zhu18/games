<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>简单互联网速度测试工具</title>
<style>
  :root{
    --bg: #f4fbff;
    --card:#ffffff;
    --primary:#3b82f6;
    --accent:#ff7aa2;
    --muted:#6b7280;
  }
  body{
    margin:0;
    font-family: "Helvetica Neue", Arial, "PingFang SC", "Microsoft Yahei", sans-serif;
    background: linear-gradient(180deg,var(--bg), #fff);
    color:#111827;
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    padding:20px;
  }
  .container{
    width:100%;
    max-width:900px;
    background:var(--card);
    border-radius:12px;
    box-shadow: 0 8px 30px rgba(15,23,42,0.08);
    padding:20px;
  }
  h1{
    margin:0 0 12px 0;
    font-size:20px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .logo {
    width:44px;height:44px;border-radius:8px;
    background:linear-gradient(135deg,var(--primary), #60a5fa);
    display:flex; align-items:center; justify-content:center;
    color:white; font-weight:700; box-shadow: 0 3px 10px rgba(59,130,246,0.25);
  }
  .desc{ color:var(--muted); font-size:13px; margin-bottom:14px;}
  .grid { display:grid; grid-template-columns: 1fr 320px; gap:18px; }
  .panel{ background:#fff; border-radius:10px; padding:14px; box-shadow: inset 0 0 0 1px rgba(15,23,42,0.03);}
  .controls label{ font-size:13px; color:var(--muted); display:block; margin-top:10px;}
  .controls input[type="text"]{ width:100%; padding:8px 10px; border-radius:8px; border:1px solid #e6eefb; margin-top:6px;}
  .controls .row{ display:flex; gap:8px; margin-top:12px;}
  button.primary{
    background:var(--primary); color:white; border:0; padding:10px 14px; border-radius:8px; cursor:pointer;
    font-weight:600;
  }
  button.ghost{ background:transparent; border:1px solid #e6eefb; padding:10px 12px; border-radius:8px; cursor:pointer;}
  .status { margin-top:12px; font-size:13px; color:var(--muted); }
  .meter { margin-top:12px; }
  .stat {
    display:flex; align-items:center; justify-content:space-between; padding:10px; border-radius:8px;
    background:linear-gradient(180deg, rgba(59,130,246,0.03), rgba(96,165,250,0.02));
    margin-bottom:8px;
  }
  .stat .label{ color:var(--muted); font-size:13px;}
  .stat .value{ font-weight:700; font-size:16px; color:#0f172a;}
  .log{ margin-top:10px; padding:10px; background:#fbfdff; border-radius:8px; font-family:monospace; font-size:12px; color:#0f172a; max-height:240px; overflow:auto;}
  .progress {
    height:10px; width:100%; background:#eef2ff; border-radius:10px; overflow:hidden; margin-top:8px;
  }
  .progress > i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--accent), #ff8aa3); transition: width 0.2s;}
  footer { margin-top:14px; font-size:12px; color:var(--muted); display:flex; justify-content:space-between; align-items:center;}
  .small{ font-size:12px; color:var(--muted); }
  @media (max-width:840px){
    .grid{ grid-template-columns: 1fr; }
    .panel{ margin-bottom:8px;}
  }
</style>
</head>
<body>
<div class="container" role="main">
  <h1><span class="logo">ST</span> 互联网速度测试工具（浏览器版）</h1>
  <div class="desc">基于浏览器的 Ping / 下载 / 上传 测试。精度依赖测试服务器是否允许 CORS 与本机网络环境。你可以替换测试 URL 以便获得更准确的结果。</div>

  <div class="grid">
    <!-- 主面板 -->
    <div class="panel">
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;">
        <div>
          <div style="font-weight:700;">测试概览</div>
          <div class="small">按顺序执行：Ping → 下载 → 上传</div>
        </div>
        <div>
          <button class="primary" id="startBtn">开始测试</button>
          <button class="ghost" id="stopBtn">停止</button>
        </div>
      </div>

      <div class="meter">
        <div class="stat"><div class="label">Ping</div><div class="value" id="pingVal">- ms</div></div>
        <div class="stat"><div class="label">下载速度</div><div class="value" id="downVal">- Mbps</div></div>
        <div class="stat"><div class="label">上传速度</div><div class="value" id="upVal">- Mbps</div></div>
      </div>

      <div id="progressArea" style="margin-top:12px;">
        <div style="font-size:13px; color:var(--muted)">下载进度</div>
        <div class="progress"><i id="downProgress"></i></div>
        <div style="font-size:13px; color:var(--muted); margin-top:8px">上传进度</div>
        <div class="progress"><i id="upProgress"></i></div>
      </div>

      <div class="log" id="log"></div>
      <footer>
        <div class="small">提示：若测试结果异常，请替换或在本地搭建允许 CORS 的测试文件与上传接口。</div>
        <div class="small">工具提供给开发/调试使用</div>
      </footer>
    </div>

    <!-- 右侧设置 -->
    <div class="panel controls">
      <div style="font-weight:700;">测试设置</div>

      <label>Ping 测试 URL（小资源，建议同域或支持 CORS）</label>
      <input id="pingUrl" type="text" value="https://www.google.com/generate_204" />

      <label>下载测试 URL（建议为一个大文件或可流式返回的字节流）</label>
      <input id="downloadUrl" type="text" value="https://speed.hetzner.de/100MB.bin" />

      <label>上传测试 URL（POST 接口，需允许 CORS）</label>
      <input id="uploadUrl" type="text" value="https://httpbin.org/post" />

      <label>上传测试大小（MB）</label>
      <input id="uploadSize" type="text" value="4" />

      <div class="row" style="margin-top:6px;">
        <button class="primary" id="applyBtn">应用设置</button>
        <button class="ghost" id="clearLog">清日志</button>
      </div>

      <div style="margin-top:12px; font-size:13px; color:var(--muted)">
        <b>常见可选测试地址（请确认允许 CORS）</b>
        <ul style="margin:6px 0 0 18px;">
          <li>Hetzner 下载文件： https://speed.hetzner.de/</li>
          <li>httpbin.org（可用于上传测试）：https://httpbin.org/</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
/*
  浏览器测速核心逻辑：
  - pingTest(url, count): 多次 fetch HEAD 或 small GET（cache-bust）测 RTT
  - downloadTest(url, durationOrBytes): fetch 并读取 body 流，统计收到字节和耗时
  - uploadTest(url, sizeMB): 生成随机数据 Blob，使用 fetch POST 测量耗时
  注意：CORS（跨域）会影响能否成功请求。使用时尽量选择支持 CORS 的测试站点或自建。
*/

(function(){
  const $ = id => document.getElementById(id);
  const logEl = $('log');
  const startBtn = $('startBtn');
  const stopBtn = $('stopBtn');
  const applyBtn = $('applyBtn');
  const clearLogBtn = $('clearLog');

  let controller = { stopped:false, abortController: null };

  function log(...args){
    const s = args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ');
    logEl.innerText = new Date().toLocaleTimeString() + "  " + s + "\\n" + logEl.innerText;
  }

  function setVal(id, v){
    $(id).innerText = v;
  }

  function setProgress(id, ratio){
    const el = $(id);
    el.style.width = Math.max(0, Math.min(100, ratio*100)) + '%';
  }

  function makeAbortController(){
    if(controller.abortController) try { controller.abortController.abort(); } catch(e){}
    controller.abortController = new AbortController();
    return controller.abortController;
  }

  async function pingTest(url, count=5){
    log("开始Ping测试 →", url, "次数:", count);
    const results = [];
    for(let i=0;i<count;i++){
      if(controller.stopped) throw new Error("stopped");
      const u = url + (url.indexOf('?')===-1 ? '?' : '&') + 'cachebust=' + Date.now() + Math.random();
      try{
        const start = performance.now();
        // 使用 fetch head 优先，但很多站点不允许 HEAD 或 CORS，改用 GET 并不读取 body。
        const ac = makeAbortController();
        const res = await fetch(u, { method:'GET', mode:'cors', cache:'no-store', signal: ac.signal });
        const end = performance.now();
        const rtt = Math.round(end - start);
        results.push(rtt);
        log("ping", i+1, "->", rtt + " ms", "status:", res.status);
        // small pause
        await new Promise(r => setTimeout(r, 100));
      }catch(err){
        log("ping error:", err && err.message ? err.message : err);
        results.push(null);
      }
    }
    const valid = results.filter(x=>typeof x === 'number');
    const avg = valid.length ? Math.round(valid.reduce((a,b)=>a+b,0)/valid.length) : null;
    log("Ping 完成，平均 RTT:", avg !== null ? (avg + " ms") : "无有效结果");
    return { all: results, avg };
  }

  async function downloadTest(url, maxBytes = 25 * 1024 * 1024){
    // 尝试通过流式读取（若支持）计算速度。maxBytes 为下载上限（字节）
    log("开始下载测试 →", url, "最大字节:", maxBytes);
    const ac = makeAbortController();
    const start = performance.now();
    let received = 0;
    try {
      const res = await fetch(url + (url.indexOf('?')===-1 ? '?' : '&') + 'cachebust=' + Date.now(), { signal: ac.signal, mode:'cors', cache:'no-store' });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const reader = res.body && res.body.getReader ? res.body.getReader() : null;
      if(!reader){
        // 不能流式读取 — 退回到 arrayBuffer
        const ab = await res.arrayBuffer();
        received = ab.byteLength;
        const duration = (performance.now() - start) / 1000;
        const bits = received * 8;
        const mbps = (bits / duration) / (1024*1024);
        log("下载完成（一次性），字节:", received, "耗时(s):", duration.toFixed(3), "Mbps:", mbps.toFixed(3));
        return { bytes: received, seconds: duration, mbps };
      }
      while(true){
        if(controller.stopped) { try{ ac.abort(); }catch(e){}; throw new Error('stopped'); }
        const { done, value } = await reader.read();
        if(done) break;
        received += value.byteLength;
        // 更新进度（基于 maxBytes）
        setProgress('downProgress', Math.min(1, received / maxBytes));
        // 如果已经达到限制就停止
        if(received >= maxBytes){
          try{ ac.abort(); }catch(e){}
          break;
        }
      }
      const duration = (performance.now() - start) / 1000;
      const bits = received * 8;
      const mbps = duration > 0 ? (bits / duration) / (1024*1024) : 0;
      log("下载完成，字节:", received, "耗时(s):", duration.toFixed(3), "Mbps:", mbps.toFixed(3));
      setProgress('downProgress', 1);
      return { bytes: received, seconds: duration, mbps };
    } catch(err){
      log("下载失败:", err && err.message ? err.message : err);
      setProgress('downProgress', 0);
      throw err;
    }
  }

  async function uploadTest(url, sizeMB = 4){
    // 生成随机二进制并 POST 到服务器（需 CORS 支持）
    const bytes = Math.max(1, Math.floor(sizeMB * 1024 * 1024));
    log("开始上传测试 →", url, "数据大小(MB):", sizeMB);
    // 生成随机 Uint8Array（分块生成以节省内存峰值）
    const chunkSize = 256 * 1024; // 256KB
    const chunks = [];
    let remaining = bytes;
    // 为了避免占用太多内存一次性生成，逐步填充BlobParts
    while(remaining > 0){
      const thisSize = Math.min(chunkSize, remaining);
      const arr = crypto.getRandomValues(new Uint8Array(thisSize));
      chunks.push(arr);
      remaining -= thisSize;
    }
    // 使用 fetch post
    const ac = makeAbortController();
    const start = performance.now();
    try{
      // 使用 streaming request body 在部分浏览器可能有限制，这里直接发送 Blob
      const blob = new Blob(chunks, { type: 'application/octet-stream' });
      const res = await fetch(url, {
        method: 'POST',
        mode: 'cors',
        cache: 'no-store',
        body: blob,
        signal: ac.signal
      });
      const end = performance.now();
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const duration = (end - start) / 1000;
      const bits = bytes * 8;
      const mbps = (bits / duration) / (1024*1024);
      log("上传完成，字节:", bytes, "耗时(s):", duration.toFixed(3), "Mbps:", mbps.toFixed(3));
      setProgress('upProgress', 1);
      return { bytes, seconds: duration, mbps };
    }catch(err){
      log("上传失败:", err && err.message ? err.message : err);
      setProgress('upProgress', 0);
      throw err;
    }
  }

  async function runAllTests(settings){
    controller.stopped = false;
    setVal('pingVal','测试中...');
    setVal('downVal','测试中...');
    setVal('upVal','测试中...');
    setProgress('downProgress', 0);
    setProgress('upProgress', 0);

    try{
      // Ping
      const pingRes = await pingTest(settings.pingUrl, settings.pingCount);
      if(pingRes && pingRes.avg !== null){
        setVal('pingVal', pingRes.avg + ' ms');
      } else {
        setVal('pingVal', '无效');
      }
      // 下载（根据设置限制字节）
      const downRes = await downloadTest(settings.downloadUrl, settings.downloadLimitBytes);
      setVal('downVal', (downRes.mbps).toFixed(2) + ' Mbps');
      // 上传
      const upRes = await uploadTest(settings.uploadUrl, settings.uploadMB);
      setVal('upVal', (upRes.mbps).toFixed(2) + ' Mbps');
      log("全部测试完成。");
    }catch(err){
      if((err && err.message) === 'stopped'){
        log("测试已被停止。");
      } else {
        log("测试过程中出错:", err && err.message ? err.message : err);
      }
    } finally {
      controller.stopped = true;
    }
  }

  // 事件绑定
  startBtn.addEventListener('click', ()=>{
    controller.stopped = false;
    const settings = {
      pingUrl: $('pingUrl').value || 'https://www.baidu.com/',
      downloadUrl: $('downloadUrl').value || 'https://speed.hetzner.de/100MB.bin',
      uploadUrl: $('uploadUrl').value || 'https://httpbin.org/post',
      uploadMB: Math.max(0.5, parseFloat($('uploadSize').value) || 4),
      pingCount: 4,
      downloadLimitBytes: 25 * 1024 * 1024 // 25MB 默认上限
    };
    // 开始测试（不阻塞 UI）
    runAllTests(settings);
  });

  stopBtn.addEventListener('click', ()=>{
    controller.stopped = true;
    if(controller.abortController) try{ controller.abortController.abort(); }catch(e){}
    log("用户点击停止。");
  });

  applyBtn.addEventListener('click', ()=>{
    log("已应用设置：", { pingUrl: $('pingUrl').value, downloadUrl: $('downloadUrl').value, uploadUrl: $('uploadUrl').value, uploadSize: $('uploadSize').value + 'MB'});
  });

  clearLogBtn.addEventListener('click', ()=> { logEl.innerText = ''; });

  // 小 helper 显示初始空值
  setVal('pingVal','- ms');
  setVal('downVal','- Mbps');
  setVal('upVal','- Mbps');

})();
</script>
</body>
</html>
